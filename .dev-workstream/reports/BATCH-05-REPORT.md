# BATCH-05 Report: Compiler - Graph Builder & Parser

## Status
**Complete**

## Implementation Details

### 1. New Projects
- Created `src/Fhsm.Compiler/Fhsm.Compiler.csproj` targeting .NET 8.
- Added reference to `Fhsm.Kernel`.
- Configured solution to include the new project.

### 2. Graph Architecture
Implemented the intermediate graph namespace `Fhsm.Compiler.Graph`:
- **StateNode**: Mutable node with Children, Transitions, and Action strings.
- **TransitionNode**: Connection between states with EventId, Guard, Action, and Priority.
- **RegionNode**: Container for orthogonal regions (stubbed for structure).
- **StateMachineGraph**: Root container holding the global lookup tables (States, Events).

### 3. Fluent Builder API
Implemented `Fhsm.Compiler.HsmBuilder` providing a user-friendly API:
- `HsmBuilder`: Entry point, manages global resources (Events, Action registry).
- `StateBuilder`: Configures specific states (Entry/Exit actions, hierarchy).
- `TransitionBuilder`: Configures transitions between states.

**Key Design Decisions:**
- **Transition Creation**: Modified `TransitionNode` constructor to allow `null` Target initially. The `TransitionBuilder` creates the node immediately to allow configuring Guards/Actions, then sets the Target in `GoTo()`.
- **Internals Visibility**: Added `InternalsVisibleTo("Fhsm.Tests")` to allow unit tests to inspect the internal Graph structure generated by the public Builder API.

### 4. Verification
Created `tests/Fhsm.Tests/Compiler/BuilderTests.cs` with **18 tests** covering:
- Graph creation and structure.
- State hierarchy (Parent/Child relationships).
- Transition configuration (EventId mapping, Target resolution).
- Guard/Action string registration.
- Error handling (Duplicate states, Unknown events/targets).
- Builder API fluency.

## Test Results
- **Total Tests**: 107 passing (89 previous + 18 new).
- **New Coverage**: `Fhsm.Compiler.HsmBuilder` and Graph components.
- **Execution Time**: ~2.1s total.

## Next Steps
- Implement **Validation Pass** (detect orphans, circles, invalid logic).
- Implement **Normalization Pass** (assign implicit IDs).
- Begin **Flattening** logic (convert Graph to Blob).
